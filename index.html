<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>UNIKAT ‚Äî Acid Breakout (v6.5)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root { --brand:#EC4848; --bg:#000; --fg:#fff; --accent:#ffef00; }
* { box-sizing:border-box; }
html,body { margin:0; background:var(--bg); color:var(--fg); font-family:Poppins,system-ui,-apple-system,Arial,sans-serif; }
.wrap { max-width:1080px; margin:0 auto; padding:14px; display:grid; grid-template-columns:1fr 320px; gap:14px; }
header { grid-column:1 / -1; display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
.h1 { font-weight:800; letter-spacing:.4px; text-shadow:0 0 18px rgba(236,72,72,.35),0 0 2px rgba(255,255,255,.6); }
.controls-row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.sound-btn { border:1px solid var(--brand); background:#000; color:#fff; padding:6px 10px; cursor:pointer; }
.badge-pill { font-size:12px; border:1px solid var(--brand); padding:2px 8px; border-radius:999px; opacity:.95 }
.container { position:relative; width:100%; max-width:520px; }
.ratio { position:relative; width:100%; aspect-ratio:2 / 3; }
#game { position:absolute; inset:0; width:100%; height:100%; border:2px solid var(--brand);
  background: radial-gradient(circle at 50% 20%, rgba(236,72,72,.16), transparent 40%), #000;
  box-shadow: inset 0 0 28px rgba(236,72,72,.25); touch-action:none; }
.badges { display:flex; gap:6px; margin-top:10px; font-size:12px; flex-wrap:wrap; }
.badge { border:1px solid var(--brand); padding:2px 6px; border-radius:8px; opacity:.9 }
.side { border:1px solid var(--brand); padding:10px; position:sticky; top:10px; height:fit-content; }
.side h2 { margin:6px 0 10px; font-size:16px; font-weight:800; }
ol#scores { margin:0; padding-left:18px; }
li.first { background: rgba(236,72,72,0.12); border-left: 3px solid var(--brand); padding: 4px 6px; border-radius:6px; }
.row { display:flex; justify-content:space-between; gap:10px; font-size:14px; align-items:center; }
.nick { max-width: 140px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.code { font-size:12px; opacity:.85; }
.star { color:#EC4848; margin-right:6px; }
.label { font-size:11px; padding:2px 6px; border:1px solid #EC4848; border-radius:999px; margin-left:8px; }
input,button { padding:8px; background:#000; border:1px solid var(--brand); color:#fff; }
button.save { background:var(--brand); color:#000; font-weight:700; border:none; cursor:pointer; }
.hint { font-size:12px; opacity:.95; margin-top:6px; }
.grid-bg { position:fixed; inset:0; pointer-events:none; background:
  radial-gradient(circle at 50% 50%, rgba(236,72,72,.08), transparent 40%),
  repeating-linear-gradient(0deg, rgba(236,72,72,.14) 0 1px, transparent 1px 30px),
  repeating-linear-gradient(90deg, rgba(236,72,72,.14) 0 1px, transparent 1px 30px);
  animation:pulse 2.6s ease-in-out infinite; z-index:0; }
@keyframes pulse { 0%,100%{opacity:.5} 50%{opacity:.9} }
@media (max-width:980px){ .wrap{grid-template-columns:1fr} .side{order:-1} }
</style>
</head>
<body>
<div class="grid-bg"></div>
<div class="wrap">
  <header>
    <div class="h1">
      <div style="font-size:22px; line-height:1">UNIKAT ‚Äî ACID BREAKOUT</div>
      <small style="opacity:.9;color:#ffd2b1;letter-spacing:.8px">UNITED IN TRANCE</small>
    </div>
    <div class="controls-row">
      <button id="soundBtn" class="sound-btn">üîä Sound an</button>
      <span id="fbStatus" class="badge-pill">Leaderboard: ‚Ä¶</span>
      <span style="font-size:12px;opacity:.8">SPACE: Start ‚Ä¢ ‚Üê/‚Üí ‚Ä¢ Maus/Touch ‚Ä¢ P: Pause ‚Ä¢ R: Restart ‚Ä¢ Tap/SPACE: Laser</span>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="ratio">
        <canvas id="game" width="480" height="720" aria-label="UNIKAT Acid Breakout"></canvas>
      </div>
    </div>

    <div class="badges">
      <div id="badge-expand" class="badge" style="display:none">Paddle+ aktiv</div>
      <div id="badge-slow" class="badge" style="display:none">Slow aktiv</div>
      <div id="badge-multi" class="badge" style="display:none">Multi-Ball</div>
      <div id="badge-laser" class="badge" style="display:none">Laser aktiv</div>
      <div id="badge-combo" class="badge" style="display:none">Combo x1</div>
    </div>

    <div class="controls-row" style="margin-top:10px">
      <input id="nickname" type="text" maxlength="16" placeholder="Nickname (ACE, LDR, ‚Ä¶)" style="flex:1;min-width:160px">
      <button id="saveBtn" class="save" disabled>Score speichern</button>
    </div>
    <div class="hint">
      Gewinne <b>1√ó G√§steliste (+1)</b>, wenn du den Highscore knackst!<br>
      Der Spieler oder die Spielerin, die <b>3 Tage vor unserem n√§chsten Event</b> den h√∂chsten Score h√§lt, erh√§lt die G√§steliste.
    </div>
  </main>

  <aside class="side">
    <h2>üèÜ All-Time Top 10</h2>
    <ol id="scores"></ol>
  </aside>
</div>

<!-- SPIEL + FIREBASE -->
<script type="module">
// ---------- Firebase laden ----------
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

// --- Deine Firebase-Konfiguration ---
const firebaseConfig = {
  apiKey: "AIzaSyC7yGSPMGzxAhQd5PaGAGwjzMvnuGxX50E",
  authDomain: "unikat-303-browser-game.firebaseapp.com",
  projectId: "unikat-303-browser-game",
};

// Verbindung aufbauen
let FB = { ok:false };
try {
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  await signInAnonymously(auth);
  FB = { ok:true, auth, db, addDoc, collection, serverTimestamp, query, orderBy, limit, onSnapshot };
} catch(e){
  console.warn("Firebase offline, fallback auf LocalStorage.", e);
  FB.ok = false;
}

// Status-Badge
const fbStatusEl = document.getElementById("fbStatus");
if (FB.ok) { fbStatusEl.textContent = "Leaderboard: online"; fbStatusEl.style.background = "rgba(30,200,120,.15)"; }
else { fbStatusEl.textContent = "Leaderboard: lokal"; fbStatusEl.style.background = "rgba(236,72,72,.15)"; }

// ---------- Spiel-Engine ----------
const BRAND="#EC4848", ACCENT="#ffef00";
const canvas=document.getElementById('game'); const ctx=canvas.getContext('2d');

// Audio
let audioCtx, muted=true;
const btn=document.getElementById('soundBtn');
function ensureAudio(){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended') audioCtx.resume(); }
btn.addEventListener('click', ()=>{ muted=!muted; if(!muted) ensureAudio(); btn.textContent = muted? 'üîá Sound aus':'üîä Sound an'; });

// 303 normal
function squelch303(freq=180){
  if(muted) return; ensureAudio();
  const o=audioCtx.createOscillator(); o.type='sawtooth';
  const f=audioCtx.createBiquadFilter(); f.type='lowpass'; f.Q.value=18;
  const eg=audioCtx.createGain();
  const dist=audioCtx.createWaveShaper();
  const curve=new Float32Array(2048);
  for(let i=0;i<curve.length;i++){ const x=i/curve.length*2-1; curve[i]=x*(0.9+0.1*Math.tanh(2*x)); }
  dist.curve=curve;
  o.connect(f); f.connect(dist); dist.connect(eg); eg.connect(audioCtx.destination);
  const now=audioCtx.currentTime;
  o.frequency.setValueAtTime(freq, now);
  f.frequency.setValueAtTime(400, now);
  f.frequency.exponentialRampToValueAtTime(2200, now+0.02);
  f.frequency.exponentialRampToValueAtTime(500, now+0.12);
  eg.gain.setValueAtTime(0.0001, now);
  eg.gain.exponentialRampToValueAtTime(0.16, now+0.01);
  eg.gain.exponentialRampToValueAtTime(0.0001, now+0.18);
  o.start(now); o.stop(now+0.2);
}

// 303 combo (leiser/entsch√§rft)
function acidCombo303(root=95){
  if(muted) return; ensureAudio();
  const o=audioCtx.createOscillator(); o.type='sawtooth'; o.frequency.setValueAtTime(root, audioCtx.currentTime);
  const f=audioCtx.createBiquadFilter(); f.type='lowpass'; f.Q.value=16;
  const pre=audioCtx.createGain(); pre.gain.value=0.9;
  const dist=audioCtx.createWaveShaper(); const curve=new Float32Array(44100); const k=80;
  for(let i=0;i<curve.length;i++){ const x=i/curve.length*2-1; curve[i]=(1+k)*x/(1+k*Math.abs(x)); }
  dist.curve=curve;
  const post=audioCtx.createGain(); post.gain.value=0.05; // deutlich leiser
  const delay=audioCtx.createDelay(); delay.delayTime.value=0.08;
  const fb=audioCtx.createGain(); fb.gain.value=0.18;
  delay.connect(fb); fb.connect(delay);
  o.connect(f); f.connect(pre); pre.connect(dist); dist.connect(post); post.connect(audioCtx.destination);
  post.connect(delay); delay.connect(audioCtx.destination);
  const now=audioCtx.currentTime;
  f.frequency.setValueAtTime(320, now);
  f.frequency.exponentialRampToValueAtTime(2000, now+0.10);
  f.frequency.exponentialRampToValueAtTime(700,  now+0.40);
  o.frequency.linearRampToValueAtTime(root*1.5, now+0.25);
  o.frequency.linearRampToValueAtTime(root*1.0, now+0.40);
  o.start(now); o.stop(now+0.45);
}

// UNIKAT Logo (wei√ü, eingebettet als SVG)
const logoImg = new Image();
logoImg.src = "data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIC0tPgo8c3ZnIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2aWV3Qm94PSIwIDAgNTk1LjMgODQxLjkiPjxzdHlsZT4uc3Qwe2ZpbGw6I2ZmfTwvc3R5bGU+PHBhdGggY2xhc3M9InN0MCIgZD0iTTEwOC45LDMzMlY0ODRIODcuMVYzMzJINjFWNDg0djI2LjFoMjYuMWgyMS44SDEzNVY0ODRWMzMySDEwOC45eiBNMTk2LjYsMzMydjI3LjdMMTQ4LjcsMzMydjIuNXYyMC44djIuN3YyLjVWNTEwaDI2LjFWMzc1LjVsMjkuOCwxNy4yaC04djcwLjVWNTEwaDI2LjF2LTQ2Ljl2LTYwdi0yLjVW Mzc3di0yLjNWMzMySDE5Ni42eiBNMjM4LjUsMzMydjQ2LjlsLTYuNi0zLjd2Mi4zVjQwMXYyLjVsNi42LDMuOXYwLjJsOCw0LjZoLTcuOHYzNC4xdjM2LjRsLTAuMiwyNy4zaDI2LjF2LTI3LjN2LTYwLjVsNi45LDMuOXYtMjguNGwtNi45LTMuOXYtNjIuMWgtMjYuMVYzMzJ6IE0zMzIuOSwzMzJ2NzQuN0wzMTEuMSwzOTRW MzMySDI4NXY0Ny4ydi4zVjQwNXYyLjV2MTAyLjZoMjYuMXYtODcuNWwyMS44LDEyLjZsNy42LDQuNGwwLjUsMC4yaC04djcwLjNoMjYuMXYtNjB2LTIuM3YtMjMuNnYtMi41di0xLjFsLTEyLjYtNy4zbDEyLjYtNy4xdi03NC4yaC0yNi4yVjMzMnogTTM5OC44LDM5NHYtMzZoMjEuOHY0OC42TDM5OC44LDM5NHogTTM3Mi43LDMzMlYzNTh2MjEuMXYyLjNWNDA1djIuNnYxMDIuNmg yNi4xdi04Ny41bDIxLjgsMTIuNmw3LjYsNC40bDAuNSwwLjJoLTh2NzAuM2gyNnYtNjB2LTIuM3YtMjMuNnYtMi41VjM1OFYzMzJIMzcyLjd6IE00NjAuNCwzMzJWMzU4aDIzLjh2MTUyLjFoMjYuMVYzNThoMjRWMzMySDQ2MC40eiIvPjwvc3ZnPg==";

// Spiel-Status
let base, paddle, balls, bricks, powerups, lasers, keysDown, running, paused, waitingLaunch, score, best, lives, tick, level;
let expandUntil=0, slowUntil=0, laserUntil=0, laserCooldown=0, levelIntroUntil=0;
let comboCount=0, lastHitAt=0, comboToastUntil=0;
let lastSavedCode = "";

const badgeExpand=document.getElementById('badge-expand');
const badgeSlow=document.getElementById('badge-slow');
const badgeMulti=document.getElementById('badge-multi');
const badgeLaser=document.getElementById('badge-laser');
const badgeCombo=document.getElementById('badge-combo');

function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function escapeHTML(s){ return (s||"").replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]); }
function shortCode(nick){
  nick = (nick||"anon").toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,4) || "ANON";
  const rnd = Math.floor(10000 + Math.random()*90000);
  return `${nick}-${rnd}`;
}

function resetDifficulty(){
  base={ paddleSpeed:9, ballSpeed:5.1, speedGrowthPerHit:0.01, maxBallSpeed:12, rowStart:5, rowAddEvery:1 };
}
function init(){
  resetDifficulty(); level=1; score=0; lives=3; best=Number(localStorage.getItem('acid_breakout_best')||0);
  running=true; paused=false; waitingLaunch=true; tick=0;
  expandUntil=slowUntil=laserUntil=0; laserCooldown=0; levelIntroUntil=performance.now()+1200;
  comboCount=0; lastHitAt=0; comboToastUntil=0; lastSavedCode="";
  paddle={ x:canvas.width/2-55, y:canvas.height-60, w:110, h:14, speed:base.paddleSpeed };
  balls=[ makeBall() ]; bricks=[]; powerups=[]; lasers=[]; keysDown={};
  buildLevel(level); loop();
}
function makeBall(){ return { x:paddle.x+paddle.w/2, y:paddle.y-10, r:7, vx:0, vy:-base.ballSpeed, stuck:true }; }

function buildLevel(n){
  bricks=[];
  const rows=Math.min(base.rowStart + (n-1), 12);
  const cols=10, pad=6, bw=Math.floor((canvas.width-pad*(cols+1))/cols), bh=22, offY=100;
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const type=(r%2===0)?'smiley':'logo';
      const hp = (type==='logo' ? 1 + Math.floor((n-1)/3) : 1);
      bricks.push({ x:pad+c*(bw+pad), y:offY+r*(bh+pad), w:bw, h:bh, type, hp, alive:true });
    }
  }
  const shrink = Math.max(0, Math.floor((n-1)/4)*6);
  paddle.w = Math.max(80, 110 - shrink);
}

function nextLevel(){
  level++; waitingLaunch=true; levelIntroUntil=performance.now()+1200; acidCombo303(95);
  base.ballSpeed = Math.min(base.maxBallSpeed-1, base.ballSpeed + 0.35);
  base.paddleSpeed = Math.min(14, (base.paddleSpeed||9) + 0.15);
  balls=[ makeBall() ]; powerups=[]; lasers=[]; buildLevel(level);
}

function loseLife(){ lives--; if(lives<=0) return gameOver(); balls=[ makeBall() ]; waitingLaunch=true; }
function gameOver(){ running=false; paused=false; best=Math.max(best, score); localStorage.setItem('acid_breakout_best', String(best)); document.getElementById('saveBtn').disabled=false; }

// Input
keysDown={};
document.addEventListener('keydown', (e)=>{ keysDown[e.key]=true; if(e.key===' '||e.key==='Spacebar'){ if(laserActive()) fireLaser(); else launch(); } if(e.key==='p'||e.key==='P') paused=!paused; if((e.key==='r'||e.key==='R') && !running) restart(); });
document.addEventListener('keyup', (e)=>{ keysDown[e.key]=false; });
let dragging=false;
canvas.addEventListener('pointerdown', (e)=>{ dragging=true; moveTo(e); if(waitingLaunch) launch(); else if(laserActive()) fireLaser(); });
canvas.addEventListener('pointermove', (e)=>{ if(dragging) moveTo(e); });
window.addEventListener('pointerup', ()=> dragging=false);
function moveTo(e){ const r=canvas.getBoundingClientRect(), x=e.clientX-r.left; paddle.x=Math.max(0, Math.min(canvas.width-paddle.w, x-paddle.w/2)); balls.forEach(b=>{ if(b.stuck){ b.x=paddle.x+paddle.w/2; b.y=paddle.y-b.r-1; } }); }

function launch(){ if(!waitingLaunch) return; waitingLaunch=false; balls.forEach(b=>{ b.stuck=false; const vx=(Math.random()<0.5?-1:1)*(1.8+Math.random()*1.2); b.vx=vx; b.vy=-base.ballSpeed; }); squelch303(170+Math.random()*40); }

// Powerups (Extra-Leben seltener)
function spawnPower(x,y){
  if(Math.random()>0.26) return; // Gesamt-Dropchance
  const bag = ['expand','expand','multi','slow','slow','laser','laser','life']; // life ~12.5%
  const t = bag[Math.floor(Math.random()*bag.length)];
  powerups.push({ x, y, vy:2.1, w:18, h:18, type:t });
}
function applyPower(t){
  if(t==='expand'){ paddle.w=Math.min(200, paddle.w+60); expandUntil=performance.now()+12000; badgeExpand.style.display=''; }
  else if(t==='multi'){ const clones=[]; balls.forEach(b=>{ clones.push({ x:b.x,y:b.y,r:b.r,vx:-b.vx,vy:b.vy*1.02,stuck:false }); }); balls=balls.concat(clones).slice(0,4); badgeMulti.style.display=''; setTimeout(()=>badgeMulti.style.display='none', 2500); }
  else if(t==='slow'){ balls.forEach(b=>{ b.vx*=0.7; b.vy*=0.7; }); slowUntil=performance.now()+9000; badgeSlow.style.display=''; }
  else if(t==='life'){ lives=Math.min(7, lives+1); }
  else if(t==='laser'){ laserUntil=performance.now()+10000; badgeLaser.style.display=''; }
}
function laserActive(){ return laserUntil && performance.now() < laserUntil; }
function fireLaser(){ const now=performance.now(); if(!laserActive() || now<laserCooldown) return; laserCooldown = now + 220; lasers.push({ x:paddle.x+paddle.w/2, y:paddle.y-6, w:4, h:14, speed:10 }); }

function update(){
  if(!running||paused) return; tick++;
  const now = performance.now();
  if (expandUntil && now>expandUntil){ paddle.w = Math.max(110, paddle.w - 2); if(paddle.w<=110){ expandUntil=0; badgeExpand.style.display='none'; } }
  if (slowUntil && now>slowUntil){ balls.forEach(b=>{ b.vx*=1.03; b.vy*=1.03; }); const avg=balls.reduce((s,b)=>s+Math.hypot(b.vx,b.vy),0)/balls.length; if(avg>=base.ballSpeed){ slowUntil=0; badgeSlow.style.display='none'; } }
  if (laserUntil && now>laserUntil){ laserUntil=0; badgeLaser.style.display='none'; }
  if(keysDown['ArrowLeft']||keysDown['a']||keysDown['A']) paddle.x=Math.max(0, paddle.x - (base.paddleSpeed||9));
  if(keysDown['ArrowRight']||keysDown['d']||keysDown['D']) paddle.x=Math.min(canvas.width - paddle.w, paddle.x + (base.paddleSpeed||9));
  if(waitingLaunch){ balls.forEach(b=>{ b.x=paddle.x+paddle.w/2; b.y=paddle.y-b.r-1; }); return; }

  lasers.forEach(L=> L.y -= L.speed);
  bricks.forEach(br=>{ if(!br.alive) return; lasers.forEach(L=>{ if(L.x>=br.x && L.x<=br.x+br.w && L.y<=br.y+br.h && L.y+L.h>=br.y){ br.hp--; if(br.hp<=0){ br.alive=false; score+=(br.type==='logo'?40:12); spawnPower(br.x+br.w/2, br.y+br.h/2); onBrickHit(); } } }); });
  lasers = lasers.filter(L => L.y + L.h > 80);

  balls.forEach(b=>{
    b.x+=b.vx; b.y+=b.vy;
    if(b.x - b.r <= 0){ b.x=b.r; b.vx*=-1; }
    if(b.x + b.r >= canvas.width){ b.x=canvas.width-b.r; b.vx*=-1; }
    if(b.y - b.r <= 80){ b.y=80+b.r; b.vy*=-1; }
    if(b.y - b.r > canvas.height){ b._dead=true; }
    if(b.vy>0 && b.y + b.r >= paddle.y && b.y - b.r <= paddle.y + paddle.h && b.x >= paddle.x && b.x <= paddle.x+paddle.w){
      const rel=(b.x-(paddle.x+paddle.w/2))/(paddle.w/2); const ang=rel*(Math.PI/3); const speed=Math.min(base.maxBallSpeed, Math.hypot(b.vx,b.vy)*1.02);
      b.vx=speed*Math.sin(ang); b.vy=-Math.abs(speed*Math.cos(ang)); b.y=paddle.y-b.r-1;
    }
  });
  balls = balls.filter(b=>!b._dead);
  if(balls.length===0) return loseLife();

  outer: for(const b of balls){
    for(const br of bricks){
      if(!br.alive) continue;
      if(b.x + b.r > br.x && b.x - b.r < br.x + br.w && b.y + b.r > br.y && b.y - b.r < br.y + br.h){
        const dx=(br.x+br.w/2)-b.x, dy=(br.y+br.h/2)-b.y;
        if(Math.abs(dx)>Math.abs(dy)) b.vy*=-1; else b.vx*=-1;
        br.hp--; if(br.hp<=0){ br.alive=false; score+=(br.type==='logo'?40:12); spawnPower(br.x+br.w/2, br.y+br.h/2); onBrickHit(); }
        const sp=Math.hypot(b.vx,b.vy)*(1+base.speedGrowthPerHit);
        const a=Math.atan2(b.vy,b.vx); const mag=Math.min(base.maxBallSpeed, sp);
        b.vx=Math.cos(a)*mag; b.vy=Math.sin(a)*mag;
        squelch303(150+Math.random()*80);
        break outer;
      }
    }
  }

  powerups.forEach(p=> p.y += p.vy);
  powerups = powerups.filter(p=>{ if(p.y>canvas.height) return false; if(p.y + p.h >= paddle.y && p.y <= paddle.y+paddle.h && p.x >= paddle.x && p.x <= paddle.x+paddle.w){ applyPower(p.type); return false; } return true; });

  if(bricks.every(br => !br.alive)) nextLevel();
  if(score>best){ best=score; localStorage.setItem('acid_breakout_best', String(best)); }
}

function onBrickHit(){
  const now = performance.now();
  if(now - lastHitAt < 1500){ comboCount++; } else { comboCount=1; }
  lastHitAt = now;
  const bonus = (comboCount>=2) ? Math.min(60, 6*comboCount) : 0;
  if(bonus){ score += bonus; comboToastUntil = now + 900; badgeCombo.style.display=''; badgeCombo.textContent = 'Combo x'+comboCount+' (+'+bonus+')'; setTimeout(()=>{ if(performance.now()>comboToastUntil) badgeCombo.style.display='none'; }, 1000); }
  if(comboCount>=4) acidCombo303(95);
}

function drawBG(){
  ctx.fillStyle = '#0b0806'; ctx.fillRect(0,0,canvas.width,80);
  const grd = ctx.createLinearGradient(0,0,0,80);
  grd.addColorStop(0,'rgba(236,72,72,0.35)'); grd.addColorStop(1,'rgba(236,72,72,0)');
  ctx.fillStyle = grd; ctx.fillRect(0,0,canvas.width,80);
  ctx.save(); ctx.globalAlpha=.18; ctx.strokeStyle=BRAND;
  for(let x=0;x<canvas.width;x+=30){ ctx.beginPath(); ctx.moveTo(x,80); ctx.lineTo(x,canvas.height); ctx.stroke(); }
  for(let y=80;y<canvas.height;y+=30){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }
  ctx.restore();
}
function drawHUD(){
  ctx.fillStyle='#fff'; ctx.font='800 18px Poppins, sans-serif'; ctx.fillText('UNIKAT', 12, 28);
  ctx.fillStyle='#ffd2b1'; ctx.font='600 12px Poppins, sans-serif'; ctx.fillText('UNITED IN TRANCE', 12, 46);
  ctx.fillStyle='#fff'; ctx.font='bold 16px Poppins, sans-serif';
  ctx.fillText('Score: '+score, canvas.width - 300, 26);
  ctx.fillText('Level: '+level, canvas.width - 180, 26);
  ctx.fillText('Lives: '+lives, canvas.width - 90, 26);
  if(levelIntroUntil && performance.now() < levelIntroUntil){
    ctx.fillStyle='rgba(0,0,0,0.35)'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='rgba(236,72,72,0.9)'; ctx.font='800 36px Poppins, sans-serif';
    ctx.fillText('LEVEL '+level, canvas.width/2 - 90, canvas.height/2);
  }
  if(comboToastUntil && performance.now() < comboToastUntil){
    ctx.fillStyle='rgba(0,0,0,0.35)'; ctx.fillRect(0,canvas.height-90,canvas.width,90);
    ctx.fillStyle=ACCENT; ctx.font='800 22px Poppins, sans-serif';
    ctx.fillText('ACID COMBO x'+comboCount, 20, canvas.height-50);
  }
}
function drawPaddle(){ ctx.fillStyle=BRAND; ctx.fillRect(paddle.x, paddle.y, paddle.w, paddle.h); ctx.strokeStyle='rgba(236,72,72,0.55)'; ctx.lineWidth=2; ctx.strokeRect(paddle.x-1, paddle.y-1, paddle.w+2, paddle.h+2); }
function drawBall(b){ ctx.fillStyle=ACCENT; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); ctx.fillStyle='rgba(255,255,255,0.4)'; ctx.beginPath(); ctx.arc(b.x-2,b.y-2,b.r/3,0,Math.PI*2); ctx.fill(); }

function drawBrick(br){
  if(!br.alive) return;
  if(br.type==='smiley'){
    ctx.fillStyle=ACCENT; ctx.fillRect(br.x, br.y, br.w, br.h);
    ctx.fillStyle='#000'; ctx.fillRect(br.x+br.w*0.25, br.y+5, 3, 6); ctx.fillRect(br.x+br.w*0.75-3, br.y+5, 3, 6);
    ctx.beginPath(); ctx.arc(br.x+br.w/2, br.y+br.h-6, 10, 0.15*Math.PI, 0.85*Math.PI); ctx.lineWidth=2; ctx.strokeStyle='#000'; ctx.stroke();
  } else {
    // UNIKAT-Schriftzug gr√∂√üer (breitenbasiert ~88%)
    ctx.strokeStyle=BRAND; ctx.strokeRect(br.x+1, br.y+1, br.w-2, br.h-2);
    const drawW = br.w * 0.88; const ratio = 0.2; const drawH = drawW * ratio;
    const cx = br.x + br.w/2, cy = br.y + br.h/2;
    ctx.drawImage(logoImg, cx-drawW/2, cy-drawH/2, drawW, drawH);
    if (br.hp>1){ ctx.fillStyle='rgba(236,72,72,0.22)'; ctx.fillRect(br.x, br.y, br.w, br.h); }
  }
}
function drawPower(p){ ctx.fillStyle=BRAND; ctx.fillRect(p.x-9, p.y-9, 18, 18); ctx.fillStyle='#000'; ctx.font='bold 11px Poppins, sans-serif'; const label = p.type==='expand'?'+': p.type==='multi'?'√ó2': p.type==='slow'?'‚Äì': p.type==='laser'?'‚ö°':'‚ô•'; ctx.fillText(label, p.x-6, p.y+4); }
function drawLasers(){ ctx.fillStyle=BRAND; lasers.forEach(L=> ctx.fillRect(L.x-1, L.y, 2, L.h*2)); }
function drawOverlays(){
  if(!running){
    ctx.fillStyle='rgba(0,0,0,0.65)'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle=BRAND; ctx.font='bold 34px Poppins, sans-serif'; ctx.fillText('GAME OVER', canvas.width/2 - 110, canvas.height/2 - 10);
    ctx.fillStyle='#fff'; ctx.font='bold 18px Poppins, sans-serif'; ctx.fillText('Score: '+score+'   Best: '+best, canvas.width/2 - 110, canvas.height/2 + 20);
    if(lastSavedCode){ ctx.font='16px Poppins, sans-serif'; ctx.fillText('Dein Code: '+lastSavedCode, canvas.width/2 - 110, canvas.height/2 + 46); }
    ctx.font='16px Poppins, sans-serif'; ctx.fillText('R = Neustart  ‚Ä¢  Nick eingeben & speichern f√ºr Highscore', canvas.width/2 - 210, canvas.height/2 + 72);
  }
  else if(paused){ ctx.fillStyle='rgba(0,0,0,0.5)'; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.fillStyle=BRAND; ctx.font='bold 28px Poppins, sans-serif'; ctx.fillText('PAUSE', canvas.width/2 - 50, canvas.height/2); }
  else if(waitingLaunch){ ctx.fillStyle='rgba(0,0,0,0.5)'; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.fillStyle='rgba(236,72,72,0.95)'; ctx.font='bold 20px Poppins, sans-serif'; ctx.fillText('SPACE oder Tippen: Launch!', canvas.width/2 - 130, canvas.height/2); }
}
function draw(){ ctx.clearRect(0,0,canvas.width,canvas.height); drawBG(); drawHUD(); drawPaddle(); drawLasers(); balls.forEach(drawBall); bricks.forEach(drawBrick); powerups.forEach(drawPower); drawOverlays(); }
function loop(){ if(running && !paused) update(); draw(); requestAnimationFrame(loop); }
function restart(){ init(); }

// Leaderboard: render + Firebase/Local
const listEl=document.getElementById('scores');
function renderLocalTop(){
  listEl.innerHTML = "";
  const best = Number(localStorage.getItem("acid_breakout_best")||0);
  const nick = localStorage.getItem("acid_breakout_nick") || "anon";
  const code = localStorage.getItem("acid_breakout_code") || shortCode(nick);
  if(best>0){
    const li = document.createElement("li");
    li.className = "first";
    li.innerHTML = `<div class="row"><span><span class="star">‚≠ê</span><span class="nick">${nick}</span> <span class="code">(${code})</span><span class="label">G√§stelistenplatz</span></span><strong>${best}</strong></div>`;
    listEl.appendChild(li);
  }
}

async function refreshLeaderboard(){
  if(FB.ok){
    try{
      const q = FB.query(FB.collection(FB.db, "scores"), FB.orderBy("score","desc"), FB.limit(10));
      FB.onSnapshot(q, (snap)=>{
        listEl.innerHTML="";
        let i=0;
        snap.forEach(doc=>{
          const d = doc.data();
          const li = document.createElement("li");
          if(i===0) li.className="first";
          li.innerHTML = `<div class="row">
            <span>${i===0?'<span class="star">‚≠ê</span>':''}<span class="nick">${escapeHTML(d.nick||'anon')}</span> <span class="code">(${escapeHTML(d.code||'')})</span>${i===0?'<span class="label">G√§stelistenplatz</span>':''}</span>
            <strong>${d.score}</strong>
          </div>`;
          listEl.appendChild(li);
          i++;
        });
        if(snap.empty){ renderLocalTop(); }
      });
      return;
    }catch(e){ console.warn(e); }
  }
  renderLocalTop();
}

// Score speichern (inkl. Score-Code)
const saveBtn = document.getElementById("saveBtn");
const nicknameInput = document.getElementById("nickname");
saveBtn.addEventListener("click", async ()=>{
  if(running) return;
  const nick = (nicknameInput.value||"anon").trim().slice(0,16) || "anon";
  const code = shortCode(nick);
  lastSavedCode = code;
  // Cloud
  if(FB.ok){
    try{
      await FB.addDoc(FB.collection(FB.db, "scores"), {
        nick, score: clamp(score,0,999999), code, createdAt: FB.serverTimestamp()
      });
    } catch(e){ alert("Konnte Score nicht speichern."); console.error(e); }
  }
  // Local Fallback
  localStorage.setItem("acid_breakout_nick", nick);
  localStorage.setItem("acid_breakout_code", code);
  const bestOld = Number(localStorage.getItem("acid_breakout_best")||0);
  if(score>bestOld) localStorage.setItem("acid_breakout_best", String(score));
  nicknameInput.value = nick;
  refreshLeaderboard();
});

// Enable Save-Button nach Game Over
function enableSave(){ document.getElementById('saveBtn').disabled=false; }

refreshLeaderboard();
init();
</script>
</body>
</html>
